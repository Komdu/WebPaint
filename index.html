<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Paint with Zoom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: white;
            overflow: hidden;
            touch-action: none;
        }
        
        /* Эффект частиц на фоне */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }
        
        .app-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
            z-index: 100;
            position: relative;
        }
        
        .app-title {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(to right, #ffffff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .room-info {
    position: fixed;
    top: 19px;
    left: 10px;
    display: flex
;
    align-items: center;
    gap: 10px;
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.95rem;
    font-weight: 600;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    min-width: 200px;
    max-width: 246px;
	}
        
        #roomId {
            font-size: 0.9rem;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        
        .room-link {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.85rem;
        }
        
        .room-link:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        
        #roomLink {
            margin-left: 6px;
            color: #a0e0ff;
            text-decoration: none;
            border-bottom: 1px dashed rgba(255,255,255,0.5);
            font-size: 0.85rem;
            background: none;
            padding: 6px 10px;
            max-width: none;
        }
        
        #roomLink:hover {
            color: white;
            border-bottom-color: white;
        }
        
        .content-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 100%;
            overflow: hidden;
            padding: 0;
            height: calc(100vh - 60px);
        }
        
        /* Стеклянные панели */
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            z-index: 10;
            position: relative;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            border-radius: 0;
            background: none;
            box-shadow: none;
        }
        
        .top-bar {
            display: flex;
            justify-content: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            z-index: 50;
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            gap: 15px;
        }
        
        .tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Стеклянные кнопки */
        .tool-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }
        
        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .tool-btn.active {
            background: rgba(255, 255, 255, 0.35);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .color-label {
            font-weight: 600;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        input[type="color"] {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .size-label {
            font-weight: 600;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"] {
            width: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            height: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .canvas-container {
            position: relative;
            flex: 1;
            background: rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        
        #paintCanvas {
            background: rgba(255, 255, 255, 0.95);
            cursor: crosshair;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
        
        .cursor {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff5e62;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
        }
        
        .users-panel {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 50;
        }
        
        .users-count {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .users-icon {
            font-size: 1.2rem;
            color: #ffffff;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 6px rgba(76, 175, 80, 0.5);
        }
        
        .status-dot.connecting {
            background: #FFC107;
            box-shadow: 0 0 6px rgba(255, 193, 7, 0.5);
        }
        
        .status-dot.disconnected {
            background: #F44336;
            box-shadow: 0 0 6px rgba(244, 67, 54, 0.5);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 16px;
            transform: translateX(150%);
            transition: transform 0.4s ease;
            z-index: 9000;
            max-width: 350px;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        
        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .drag-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            font-weight: 600;
            z-index: 100;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 12px;
                padding: 10px;
            }
            
            .room-info {
                position: fixed;
                top: 8px;
                left: 8px;
                font-size: 0.85rem;
                z-index: 10000;
                min-width: auto;
                padding: 6px 12px;
                max-width: calc(100% - 16px);
            }
            
            #roomId {
                font-size: 0.8rem;
                max-width: 60px;
            }
            
            .room-link {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            #roomLink {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 10px;
                padding: 8px;
                top: 5px;
                left: 5px;
                right: 5px;
            }
            
            .tools {
                justify-content: center;
            }
            
            .tool-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .users-panel {
                flex-direction: column;
                gap: 10px;
                padding: 8px;
                bottom: 5px;
                left: 5px;
                right: 5px;
            }
            
            .zoom-controls {
                bottom: 10px;
                right: 10px;
            }
            
            .zoom-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            
            .app-title {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Фоновые частицы -->
    <div id="particles-js"></div>
    
    <!-- Код комнаты в левом верхнем углу -->
    <div class="room-info glass-panel">
        <span id="roomLabel">Room:</span>
        <strong id="roomId" title="Click to copy">Loading...</strong>
        <a href="#" id="roomLink" class="room-link">Copy link</a>
    </div>
    
    <div class="content-container">
        <div class="container">
            <!-- Панель инструментов - центрирована -->
            <div class="glass-panel top-bar">
                <div class="tools">
                    <button id="pencil" class="tool-btn active">✏️</button>
                    <button id="eraser" class="tool-btn">🧽</button>
                    <button id="line" class="tool-btn">📏</button>
                    <button id="rectangle" class="tool-btn">⬜</button>
                    <button id="circle" class="tool-btn">⭕</button>
                </div>
                <div class="color-picker">
                    <input type="color" id="color" value="#ff5e62">
                    <div class="size-control">
                        <input type="range" id="brushSize" min="1" max="50" value="5">
                    </div>
                </div>
            </div>
            
            <div class="canvas-container" id="canvasContainer">
                <canvas id="paintCanvas"></canvas>
                <div class="glass-panel drag-indicator" id="dragIndicator">Canvas dragging (hold Space)</div>
                <div class="zoom-controls">
                    <button id="zoomIn" class="glass-panel zoom-btn">+</button>
                    <button id="zoomOut" class="glass-panel zoom-btn">−</button>
                    <button id="resetView" class="glass-panel zoom-btn">↺</button>
                </div>
            </div>
            
            <div class="glass-panel users-panel">
                <div class="users-count">
                    <span class="users-icon">👥</span>
                    <span id="usersCount">1</span>
                </div>
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="glass-panel notification" id="notification">
        <div id="notificationContent"></div>
    </div>

    <!-- Скрипт для фоновых частиц -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Глобальные переменные для масштабирования
        let offsetX = 0;
        let offsetY = 0;
        let scale = 1;
        let isDragging = false;
        let lastDragX = 0;
        let lastDragY = 0;
        let isSpacePressed = false;
        let canvasWidth = 0;
        let canvasHeight = 0;

        // Инициализация фоновых частиц
        document.addEventListener('DOMContentLoaded', function() {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: "#ffffff" },
                    shape: { type: "circle" },
                    opacity: { value: 0.1, random: true },
                    size: { value: 3, random: true },
                    line_linked: {
                        enable: true,
                        distance: 150,
                        color: "#ffffff",
                        opacity: 0.05,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: 1,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "out",
                        bounce: false
                    }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "grab" },
                        onclick: { enable: true, mode: "push" },
                        resize: true
                    }
                },
                retina_detect: true
            });
        });

        // Элементы DOM
        const canvas = document.getElementById('paintCanvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvasContainer');
        const colorPicker = document.getElementById('color');
        const brushSize = document.getElementById('brushSize');
        const usersCount = document.getElementById('usersCount');
        const toolButtons = document.querySelectorAll('.tool-btn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const notification = document.getElementById('notification');
        const notificationContent = document.getElementById('notificationContent');
        const roomIdElement = document.getElementById('roomId');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const resetViewBtn = document.getElementById('resetView');
        const dragIndicator = document.getElementById('dragIndicator');
        const roomLink = document.getElementById('roomLink');
        
        // Переменные приложения
        let currentTool = 'pencil';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let startX = 0;
        let startY = 0;
        let currentColor = colorPicker.value;
        let currentBrushSize = brushSize.value;
        let socket;
        let userId;
        let roomId;
        let userCursors = {};
        let usersOnline = 1;
        let drawingHistory = [];
        let historyReceived = false;
        let inviteLink = '';
        
        // Тексты для английского языка
        const text = {
            appTitle: "Collaborative Paint",
            roomLabel: "Room:",
            copyText: "Copy link",
            connecting: "Connecting...",
            connected: "✅ Connected",
            disconnected: "❌ Disconnected",
            users: " users online",
            dragIndicator: "Canvas dragging (hold Space)",
            notificationConnected: "Connected to room ",
            notificationCopied: "Link copied! Share with friends.",
            notificationError: "Connection error",
            notificationHistory: "Drawing history loaded",
            notificationClear: "Canvas cleared"
        };
        
        // Генерация уникального ID пользователя
        function generateUserId() {
            return 'user-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Генерация уникального ID комнаты
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 8);
        }
        
        // Инициализация холста
        function setupCanvas() {
            // Установка размеров холста в 2 раза больше окна
            canvasWidth = window.innerWidth * 2;
            canvasHeight = window.innerHeight * 2;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Очистка холста
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Обновление позиции холста
            updateCanvasPosition();
            
            // Инициализация событий
            initEvents();
            
            // Создание комнаты и подключение
            createRoomAndConnect();
            
            // Гарантируем, что room-info всегда поверх
            document.querySelector('.room-info').style.zIndex = '10000';
        }
        
        // Получение позиции мыши
        function getMousePos(canvas, evt) {
            const rect = canvasContainer.getBoundingClientRect();
            let clientX, clientY;
            
            if (evt.type.includes('touch')) {
                clientX = evt.touches[0].clientX;
                clientY = evt.touches[0].clientY;
            } else {
                clientX = evt.clientX;
                clientY = evt.clientY;
            }
            
            // Правильное преобразование координат с учетом масштаба и смещения
            const x = (clientX - rect.left - offsetX) / scale;
            const y = (clientY - rect.top - offsetY) / scale;
            
            return {
                x: Math.max(0, Math.min(x, canvas.width)),
                y: Math.max(0, Math.min(y, canvas.height))
            };
        }
        
        // Обновление позиции холста
        function updateCanvasPosition() {
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }
        
        // Инициализация событий
        function initEvents() {
            // События мыши
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('mousemove', updateCursorPosition);
            
            // События касания для мобильных устройств
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            // Выбор цвета
            colorPicker.addEventListener('input', () => {
                currentColor = colorPicker.value;
            });
            
            // Изменение размера кисти
            brushSize.addEventListener('input', () => {
                currentBrushSize = brushSize.value;
            });
            
            // Выбор инструмента
            toolButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Удаляем активный класс у всех кнопок
                    toolButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Добавляем активный класс к текущей кнопке
                    button.classList.add('active');
                    
                    // Устанавливаем текущий инструмент
                    currentTool = button.id;
                });
            });
            
            // Копирование ссылки на комнату
            roomLink.addEventListener('click', copyRoomLink);
            roomIdElement.addEventListener('click', copyRoomLink);
            
            // Масштабирование
            canvasContainer.addEventListener('wheel', handleZoom, { passive: false });
            zoomInBtn.addEventListener('click', () => zoom(1.2));
            zoomOutBtn.addEventListener('click', () => zoom(0.8));
            resetViewBtn.addEventListener('click', resetView);
            
            // Перемещение холста
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    isSpacePressed = true;
                    dragIndicator.style.display = 'block';
                }
            });
            
            document.addEventListener('keyup', (e) => {
                if (e.code === 'Space') {
                    isSpacePressed = false;
                    dragIndicator.style.display = 'none';
                }
            });
            
            canvas.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
        }
        
        // Обработка масштабирования колесиком мыши
        function handleZoom(e) {
            e.preventDefault();
            
            const rect = canvasContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const zoomFactor = wheel > 0 ? 1 + zoomIntensity : 1 - zoomIntensity;
            
            zoom(zoomFactor, mouseX, mouseY);
        }
        
        // Масштабирование
        function zoom(factor, centerX, centerY) {
            const prevScale = scale;
            
            // Применяем ограничения масштабирования
            scale *= factor;
            scale = Math.max(0.1, Math.min(scale, 5));
            
            // Если указан центр масштабирования, корректируем смещение
            if (centerX !== undefined && centerY !== undefined) {
                const containerRect = canvasContainer.getBoundingClientRect();
                const containerX = centerX - containerRect.left;
                const containerY = centerY - containerRect.top;
                
                // Рассчитываем смещение для сохранения позиции под курсором
                offsetX -= (containerX - offsetX) * (scale / prevScale - 1);
                offsetY -= (containerY - offsetY) * (scale / prevScale - 1);
            }
            
            updateCanvasPosition();
        }
        
        // Сброс вида
        function resetView() {
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            updateCanvasPosition();
        }
        
        // Начало перемещения холста
        function startDrag(e) {
            if (isSpacePressed) {
                e.preventDefault();
                isDragging = true;
                lastDragX = e.clientX;
                lastDragY = e.clientY;
                canvasContainer.style.cursor = 'grabbing';
            }
        }
        
        // Обработка перемещения холста
        function handleDrag(e) {
            if (isDragging && isSpacePressed) {
                e.preventDefault();
                const deltaX = e.clientX - lastDragX;
                const deltaY = e.clientY - lastDragY;
                
                offsetX += deltaX;
                offsetY += deltaY;
                
                lastDragX = e.clientX;
                lastDragY = e.clientY;
                
                updateCanvasPosition();
            }
        }
        
        // Окончание перемещения холста
        function stopDrag() {
            isDragging = false;
            canvasContainer.style.cursor = 'default';
        }
        
        // Создание комнаты и подключение к WebSocket
        function createRoomAndConnect() {
            // Генерация ID пользователя и комнаты
            userId = generateUserId();
            
            // Проверяем, есть ли roomId в URL
            const hash = window.location.hash.substring(1);
            if (hash) {
                roomId = hash;
            } else {
                roomId = generateRoomId();
                window.location.hash = roomId;
            }
            
            // Укорачиваем ID комнаты для отображения
            const displayRoomId = roomId.length > 9 ? 
                roomId.substring(0, 6) + '...' : roomId;
            
            // Отображаем ID комнаты
            roomIdElement.textContent = displayRoomId;
            
            // Сохраняем ссылку для приглашения
            inviteLink = window.location.href;
            
            // Добавляем подсказку
            roomIdElement.title = `Room ID: ${roomId}\nFull link: ${inviteLink}\nClick to copy`;
            roomIdElement.style.cursor = 'pointer';
            
            // Подключение к серверу
            connectToServer();
        }
        
        // Подключение к серверу
        function connectToServer() {
            updateConnectionStatus('connecting', text.connecting);
            
            // Используем публичный WebSocket сервер
            socket = new WebSocket('https://9b41bea9-c406-4e23-a8b0-4accde7e34fa-00-29xh0hilv19sy.sisko.replit.dev/');
            
            socket.addEventListener('open', () => {
                updateConnectionStatus('connected', text.connected);
                showNotification(text.notificationConnected + roomId + '!');
                
                // Отправляем информацию о новом пользователе
                sendData({
                    type: 'join',
                    userId: userId,
                    color: currentColor,
                    roomId: roomId
                });
                
                // Запрашиваем историю рисунков
                if (!historyReceived) {
                    sendData({
                        type: 'requestHistory',
                        userId: userId,
                        roomId: roomId
                    });
                }
            });
            
            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (e) {
                    console.error('Ошибка обработки сообщения:', e);
                }
            });
            
            socket.addEventListener('error', (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('disconnected', text.disconnected);
                showNotification(text.notificationError);
            });
            
            socket.addEventListener('close', () => {
                updateConnectionStatus('disconnected', text.disconnected);
                showNotification(text.notificationError);
            });
        }
        
        // Обработка сообщений от сервера
        function handleServerMessage(data) {
            // Игнорируем сообщения из других комнат
            if (data.roomId !== roomId) return;
            
            // Игнорируем собственные сообщения
            if (data.userId === userId) return;
            
            switch (data.type) {
                case 'draw':
                    drawRemote(data);
                    addToHistory(data);
                    break;
                case 'shape':
                    drawShapeRemote(data);
                    addToHistory(data);
                    break;
                case 'clear':
                    clearCanvas();
                    addToHistory(data);
                    break;
                case 'cursor':
                    updateRemoteCursor(data);
                    break;
                case 'join':
                    handleUserJoin(data);
                    break;
                case 'leave':
                    handleUserLeave(data);
                    break;
                case 'history':
                    replayHistory(data.history);
                    break;
                case 'requestHistory':
                    sendHistory(data.userId);
                    break;
                case 'users':
                    updateUsersCount(data.count);
                    break;
            }
        }
        
        // Добавление действия в историю
        function addToHistory(action) {
            drawingHistory.push(action);
        }
        
        // Отправка истории новому пользователю
        function sendHistory(targetUserId) {
            sendData({
                type: 'history',
                userId: userId,
                targetUserId: targetUserId,
                roomId: roomId,
                history: drawingHistory
            });
        }
        
        // Воспроизведение истории рисунков
        function replayHistory(history) {
            if (historyReceived) return;
            
            historyReceived = true;
            
            // Очищаем холст
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Воспроизводим всю историю
            history.forEach(item => {
                switch (item.type) {
                    case 'draw':
                        drawRemote(item);
                        break;
                    case 'shape':
                        drawShapeRemote(item);
                        break;
                    case 'clear':
                        clearCanvas();
                        break;
                }
            });
            
            // Сохраняем историю
            drawingHistory = [...history];
            
            showNotification(text.notificationHistory);
        }
        
        // Обновление статуса подключения
        function updateConnectionStatus(status, textMessage) {
            statusText.textContent = textMessage;
            statusDot.className = 'status-dot';
            
            switch(status) {
                case 'connecting':
                    statusDot.classList.add('connecting');
                    break;
                case 'connected':
                    statusDot.classList.add('connected');
                    break;
                case 'disconnected':
                    statusDot.classList.add('disconnected');
                    break;
            }
        }
        
        // Показ уведомления
        function showNotification(message) {
            notificationContent.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Отправка данных на сервер
        function sendData(data) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                // Добавляем ID пользователя и комнаты к данным
                const dataToSend = {
                    ...data,
                    userId: userId,
                    roomId: roomId
                };
                socket.send(JSON.stringify(dataToSend));
            }
        }
        
        // Обновление позиции курсора
        function updateCursorPosition(e) {
            const pos = getMousePos(canvas, e);
            sendData({
                type: 'cursor',
                x: pos.x,
                y: pos.y,
                color: currentColor
            });
        }
        
        // Обработчики событий для рисования
        function startDrawing(e) {
            if (isSpacePressed) return;
            
            isDrawing = true;
            const pos = getMousePos(canvas, e);
            [lastX, lastY] = [pos.x, pos.y];
            [startX, startY] = [pos.x, pos.y];
        }
        
        function draw(e) {
            if (!isDrawing || isSpacePressed) return;
            
            const pos = getMousePos(canvas, e);
            const currentX = pos.x;
            const currentY = pos.y;
            
            ctx.lineWidth = currentTool === 'eraser' ? currentBrushSize * 2 : currentBrushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (currentTool === 'pencil' || currentTool === 'eraser') {
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
                ctx.stroke();
                
                // Отправка данных на сервер
                sendData({
                    type: 'draw',
                    fromX: lastX,
                    fromY: lastY,
                    toX: currentX,
                    toY: currentY,
                    color: currentTool === 'eraser' ? 'white' : currentColor,
                    lineWidth: ctx.lineWidth
                });
                
                // Добавляем в историю
                addToHistory({
                    type: 'draw',
                    fromX: lastX,
                    fromY: lastY,
                    toX: currentX,
                    toY: currentY,
                    color: currentTool === 'eraser' ? 'white' : currentColor,
                    lineWidth: ctx.lineWidth
                });
                
                [lastX, lastY] = [currentX, currentY];
            }
        }
        
        function stopDrawing() {
            if (!isDrawing) return;
            
            if (currentTool === 'line' || currentTool === 'rectangle' || currentTool === 'circle') {
                const endX = lastX;
                const endY = lastY;
                
                drawShape(startX, startY, endX, endY);
                
                // Отправка данных на сервер
                sendData({
                    type: 'shape',
                    shape: currentTool,
                    startX: startX,
                    startY: startY,
                    endX: endX,
                    endY: endY,
                    color: currentColor
                });
                
                // Добавляем в историю
                addToHistory({
                    type: 'shape',
                    shape: currentTool,
                    startX: startX,
                    startY: startY,
                    endX: endX,
                    endY: endY,
                    color: currentColor
                });
            }
            
            isDrawing = false;
        }
        
        // Обработчики для сенсорных устройств
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                // Масштабирование двумя пальцами
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                const initialDistance = Math.sqrt(dx * dx + dy * dy);
                
                canvas.initialDistance = initialDistance;
                canvas.initialScale = scale;
                canvas.initialOffsetX = offsetX;
                canvas.initialOffsetY = offsetY;
                canvas.midX = (touch1.clientX + touch2.clientX) / 2;
                canvas.midY = (touch1.clientY + touch2.clientY) / 2;
            } else if (e.touches.length === 1) {
                // Один палец - рисование
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }
        
        function handleTouchMove(e) {
            if (e.touches.length === 2) {
                // Масштабирование двумя пальцами
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                const currentDistance = Math.sqrt(dx * dx + dy * dy);
                
                if (canvas.initialDistance) {
                    const scaleFactor = currentDistance / canvas.initialDistance;
                    scale = canvas.initialScale * scaleFactor;
                    scale = Math.max(0.1, Math.min(scale, 5));
                    
                    // Рассчитываем смещение для сохранения позиции под пальцами
                    const rect = canvasContainer.getBoundingClientRect();
                    const currentMidX = (touch1.clientX + touch2.clientX) / 2;
                    const currentMidY = (touch1.clientY + touch2.clientY) / 2;
                    
                    offsetX = canvas.initialOffsetX + (currentMidX - canvas.midX);
                    offsetY = canvas.initialOffsetY + (currentMidY - canvas.midY);
                    
                    updateCanvasPosition();
                }
            } else if (e.touches.length === 1) {
                // Один палец - рисование
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }
        
        // Рисование фигур
        function drawShape(startX, startY, endX, endY) {
            ctx.beginPath();
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            
            switch (currentTool) {
                case 'line':
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                    break;
                case 'rectangle':
                    const width = endX - startX;
                    const height = endY - startY;
                    ctx.strokeRect(startX, startY, width, height);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    break;
            }
        }
        
        // Очистка холста
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Отправка события очистки на сервер
            sendData({ type: 'clear' });
            
            // Добавляем в историю
            addToHistory({ type: 'clear' });
            
            showNotification(text.notificationClear);
        }
        
        // Обработка удалённых событий рисования
        function drawRemote(data) {
            // Сохраняем текущие настройки контекста
            const prevStrokeStyle = ctx.strokeStyle;
            const prevLineWidth = ctx.lineWidth;
            
            ctx.beginPath();
            ctx.moveTo(data.fromX, data.fromY);
            ctx.lineTo(data.toX, data.toY);
            ctx.strokeStyle = data.color;
            ctx.lineWidth = data.lineWidth;
            ctx.stroke();
            
            // Восстанавливаем настройки
            ctx.strokeStyle = prevStrokeStyle;
            ctx.lineWidth = prevLineWidth;
        }
        
        // Обработка удалённых фигур
        function drawShapeRemote(data) {
            // Сохраняем текущие настройки контекста
            const prevStrokeStyle = ctx.strokeStyle;
            const prevLineWidth = ctx.lineWidth;
            
            ctx.beginPath();
            ctx.strokeStyle = data.color;
            ctx.lineWidth = 3;
            
            switch (data.shape) {
                case 'line':
                    ctx.moveTo(data.startX, data.startY);
                    ctx.lineTo(data.endX, data.endY);
                    ctx.stroke();
                    break;
                case 'rectangle':
                    const width = data.endX - data.startX;
                    const height = data.endY - data.startY;
                    ctx.strokeRect(data.startX, data.startY, width, height);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(data.endX - data.startX, 2) + Math.pow(data.endY - data.startY, 2));
                    ctx.arc(data.startX, data.startY, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    break;
            }
            
            // Восстанавливаем настройки
            ctx.strokeStyle = prevStrokeStyle;
            ctx.lineWidth = prevLineWidth;
        }
        
        // Обновление удалённых курсоров
        function updateRemoteCursor(data) {
            // Сохраняем данные о курсоре
            userCursors[data.userId] = {
                x: data.x,
                y: data.y,
                color: data.color
            };
            
            // Обновляем отображение курсоров
            updateCursorsDisplay();
        }
        
        // Обновление отображения курсоров
        function updateCursorsDisplay() {
            // Удаляем все существующие курсоры
            document.querySelectorAll('.remote-cursor').forEach(el => el.remove());
            
            // Добавляем курсоры для всех пользователей
            for (const userId in userCursors) {
                if (userId !== window.userId) {
                    const cursor = userCursors[userId];
                    
                    // Преобразуем виртуальные координаты в экранные
                    const screenX = cursor.x * scale + offsetX;
                    const screenY = cursor.y * scale + offsetY;
                    
                    const cursorElement = document.createElement('div');
                    cursorElement.className = 'cursor remote-cursor';
                    cursorElement.style.left = `${screenX}px`;
                    cursorElement.style.top = `${screenY}px`;
                    cursorElement.style.backgroundColor = cursor.color || '#ff5e62';
                    cursorElement.style.borderColor = '#fff';
                    canvasContainer.appendChild(cursorElement);
                }
            }
        }
        
        // Обработка подключения нового пользователя
        function handleUserJoin(data) {
            usersOnline++;
            updateUsersCount(usersOnline);
            showNotification(`New user joined!`);
        }
        
        // Обработка отключения пользователя
        function handleUserLeave(data) {
            delete userCursors[data.userId];
            usersOnline--;
            updateUsersCount(usersOnline);
            updateCursorsDisplay();
        }
        
        // Обновление счётчика пользователей
        function updateUsersCount(count) {
            usersCount.textContent = count;
        }
        
        // Копирование ссылки для приглашения
        function copyRoomLink(e) {
            e.preventDefault();
            
            const textArea = document.createElement('textarea');
            textArea.value = inviteLink;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Визуальное подтверждение
            roomLink.textContent = "Copied!";
            setTimeout(() => {
                roomLink.textContent = "Copy link";
            }, 2000);
            
            showNotification(text.notificationCopied);
        }
        
        // Запуск приложения
        window.addEventListener('load', () => {
            setupCanvas();
            window.userId = userId; // Делаем userId глобальной для использования в других функциях
            
            // Обновление курсоров с частотой 30 FPS
            setInterval(updateCursorsDisplay, 33);
        });
        
        // Обработка изменения размера окна
        window.addEventListener('resize', () => {
            // Обновляем размеры холста при изменении окна
            canvasWidth = window.innerWidth * 2;
            canvasHeight = window.innerHeight * 2;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Перерисовываем историю
            if (historyReceived) {
                replayHistory(drawingHistory);
            }
            
            updateCanvasPosition();
        });
    </script>
</body>
</html>